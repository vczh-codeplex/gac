<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=8" />
<link rel="Stylesheet" type="text/css" href="../../PageStyle.css" />
<title>GacLib - Demos - Controls.ListView.VirtualMode</title>
</head>
<body>
<table class="ContainerTable">
    <tr>
        <td align="center" valign="top">
            <table class="NavigateTable" cellpadding="0" cellspacing="4" >
                <tr>
                    <td class="NavigateHeader" colspan="6" align="left">
                        <img src="../../GacLib_LogoAndTitle.gif" alt="GacLib -- GPU Accelerated C++ User Interface"/>
                    </td>
                </tr>
                <tr>
                    <td align="center" valign="middle">
                        <a class="MenuButton HomeButton" href="../../index.html">
                            HOME
                        </a>
                    </td>
                    <td align="center" valign="middle">
                        <a class="MenuButton GettingStartButton" href="../../GettingStart.html">
                            GETTING START
                        </a>
                    </td>
                    <td align="center" valign="middle">
                        <a class="MenuButton DemosButtonSelected" href="../../Demos.html">
                            DEMOS
                        </a>
                    </td>
                    <td align="center" valign="middle">
                        <a class="MenuButton DownloadButton" href="../../Download.html">
                            DOWNLOAD
                        </a>
                    </td>
                    <td align="center" valign="middle">
                        <a class="MenuButton DocumentButton" href="../../StaticHtmlDoc/reference_gacui.html">
                            DOCUMENT
                        </a>
                    </td>
                    <td align="center" valign="middle">
                        <a class="MenuButton ContactButton" href="../../Contact.html">
                            CONTACT
                        </a>
                    </td>
                </tr>
                <tr>
                    <td align="left" valign="top" colspan="6">
                        <h1>ListView.VirtualMode</h1>
                        <img src="DXGUI_47.jpg" />
                        <pre class="CppCode">
#include "..\..\Public\Source\GacUI.h"
#include &lt;ShlObj.h&gt;

using namespace vl::collections;

int CALLBACK WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int CmdShow)
{
	return SetupWindowsDirect2DRenderer();
}

extern WString GetWindowsDirectory();
extern void SearchDirectoriesAndFiles(const WString& path, List&lt;WString&gt;& directories, List&lt;WString&gt;& files);
extern Ptr&lt;GuiImageData&gt; GetFileIcon(const WString& fullPath, UINT uFlags);
extern WString GetFileDisplayName(const WString& fullPath);
extern WString GetFileTypeName(const WString& fullPath);
extern WString GetFileLastWriteTime(const WString& fullPath);
extern WString GetFileSize(const WString& fullPath);

/***********************************************************************
FileProperties
***********************************************************************/

class FileProperties
{
private:
	Ptr&lt;GuiImageData&gt;	smallIcon;
	Ptr&lt;GuiImageData&gt;	bigIcon;
	WString				displayName;
	WString				typeName;
	WString				lastWriteTime;
	WString				size;
	WString				fullPath;
public:
	FileProperties(const WString& _fullPath)
		:fullPath(_fullPath)
	{
	}

	Ptr&lt;GuiImageData&gt; GetSmallIcon()
	{
		if(!smallIcon)
		{
			smallIcon=GetFileIcon(fullPath, SHGFI_SMALLICON | SHGFI_ICON);
		}
		return smallIcon;
	}

	Ptr&lt;GuiImageData&gt; GetBigIcon()
	{
		if(!bigIcon)
		{
			bigIcon=GetFileIcon(fullPath, SHGFI_LARGEICON | SHGFI_ICON);
		}
		return bigIcon;
	}

	WString GetDisplayName()
	{
		if(displayName==L"")
		{
			displayName=GetFileDisplayName(fullPath);
		}
		return displayName;
	}

	WString GetTypeName()
	{
		if(typeName==L"")
		{
			typeName=GetFileTypeName(fullPath);
		}
		return typeName;
	}

	WString GetLastWriteTime()
	{
		if(lastWriteTime==L"")
		{
			lastWriteTime=GetFileLastWriteTime(fullPath);
		}
		return lastWriteTime;
	}

	WString GetSize()
	{
		if(size==L"")
		{
			size=GetFileSize(fullPath);
		}
		return size;
	}
};

/***********************************************************************
DataSource
***********************************************************************/

class DataSource : public list::ItemProviderBase, public list::ListViewItemStyleProvider::IListViewItemView, public list::ListViewColumnItemArranger::IColumnItemView
{
	typedef List&lt;list::ListViewColumnItemArranger::IColumnItemViewCallback*&gt;		ColumnItemViewCallbackList;
private:
	List&lt;Ptr&lt;FileProperties&gt;&gt;		fileProperties;
	ColumnItemViewCallbackList		columnItemViewCallbacks;
	int								columnSizes[4];
public:
	DataSource()
	{
		for(int i=0;i&lt;4;i++)
		{
			columnSizes[i]=i==0?230:120;
		}
	}

	void SetDirectory(const WString& directory)
	{
		int oldCount=fileProperties.Count();
		fileProperties.Clear();
		
		// Enumerate all directories and files in the Windows directory.
		List&lt;WString&gt; directories;
		List&lt;WString&gt; files;
		SearchDirectoriesAndFiles(directory, directories, files);
		FOREACH(WString, file, directories.Wrap()&gt;&gt;Concat(files.Wrap()))
		{
			fileProperties.Add(new FileProperties(directory+L"\\"+file));
		}

		<strong>InvokeOnItemModified(0, oldCount, fileProperties.Count());</strong>
	}

	// GuiListControl::IItemProvider

	int Count()
	{
		return fileProperties.Count();
	}

	IDescriptable* RequestView(const WString& identifier)
	{
		if(identifier==list::ListViewItemStyleProvider::IListViewItemView::Identifier)
		{
			return this;
		}
		else if(identifier==list::ListViewColumnItemArranger::IColumnItemView::Identifier)
		{
			return this;
		}
		else
		{
			return 0;
		}
	}

	void ReleaseView(IDescriptable* view)
	{
	}

	// GuiListControl::IItemPrimaryTextView

	WString GetPrimaryTextViewText(int itemIndex)
	{
		return GetText(itemIndex);
	}

	bool ContainsPrimaryText(int itemIndex)
	{
		return true;
	}

	// list::ListViewItemStyleProvider::IListViewItemView
	
	Ptr&lt;GuiImageData&gt; GetSmallImage(int itemIndex)
	{
		if(0&lt;=itemIndex && itemIndex&lt;fileProperties.Count())
		{
			return fileProperties[itemIndex]-&gt;GetSmallIcon();
		}
		return 0;
	}

	Ptr&lt;GuiImageData&gt; GetLargeImage(int itemIndex)
	{
		if(0&lt;=itemIndex && itemIndex&lt;fileProperties.Count())
		{
			return fileProperties[itemIndex]-&gt;GetBigIcon();
		}
		return 0;
	}

	WString GetText(int itemIndex)
	{
		if(0&lt;=itemIndex && itemIndex&lt;fileProperties.Count())
		{
			return fileProperties[itemIndex]-&gt;GetDisplayName();
		}
		return L"";
	}

	WString GetSubItem(int itemIndex, int index)
	{
		if(0&lt;=itemIndex && itemIndex&lt;fileProperties.Count() && 0&lt;=index && index&lt;3)
		{
			switch(index)
			{
			case 0:
				return fileProperties[itemIndex]-&gt;GetTypeName();
			case 1:
				return fileProperties[itemIndex]-&gt;GetLastWriteTime();
			case 2:
				return fileProperties[itemIndex]-&gt;GetSize();
			}
		}
		return L"";
	}

	int GetDataColumnCount()
	{
		return 2;
	}

	int GetDataColumn(int index)
	{
		return index;
	}

	// list::ListViewColumnItemArranger::IColumnItemView
						
	bool AttachCallback(list::ListViewColumnItemArranger::IColumnItemViewCallback* value)
	{
		if(columnItemViewCallbacks.Contains(value))
		{
			return false;
		}
		else
		{
			columnItemViewCallbacks.Add(value);
			return true;
		}
	}

	bool DetachCallback(list::ListViewColumnItemArranger::IColumnItemViewCallback* value)
	{
		int index=columnItemViewCallbacks.IndexOf(value);
		if(index==-1)
		{
			return false;
		}
		else
		{
			columnItemViewCallbacks.Remove(value);
			return true;
		}
	}

	int GetColumnCount()
	{
		return 4;
	}

	WString GetColumnText(int index)
	{
		switch(index)
		{
		case 0:
			return L"Name";
		case 1:
			return L"Type";
		case 2:
			return L"Date";
		case 3:
			return L"Size";
		default:
			return L"";
		}
	}

	int GetColumnSize(int index)
	{
		if(0&lt;=index && index&lt;4)
		{
			return columnSizes[index];
		}
		else
		{
			return -1;
		}
	}

	void SetColumnSize(int index, int value)
	{
		if(0&lt;=index && index&lt;4)
		{
			columnSizes[index]=value;
			for(int i=0;i&lt;columnItemViewCallbacks.Count();i++)
			{
				columnItemViewCallbacks[i]-&gt;OnColumnSizeChanged(index);
			}
		}
	}
};

/***********************************************************************
VirtualModeWindow
***********************************************************************/

class VirtualModeWindow : public GuiWindow
{
private:
	DataSource*						dataSource;
	GuiVirtualListView*				listView;
	GuiComboBoxListControl*			comboView;
	GuiSinglelineTextBox*			textDirectory;
	GuiButton*						buttonRefresh;
<strong>
	void comboView_SelectedIndexChanged(GuiGraphicsComposition* sender, GuiEventArgs& arguments)
	{
		switch(comboView-&gt;GetSelectedIndex())
		{
		case 0:
			listView-&gt;ChangeItemStyle(new list::ListViewBigIconContentProvider);
			break;
		case 1:
			listView-&gt;ChangeItemStyle(new list::ListViewSmallIconContentProvider);
			break;
		case 2:
			listView-&gt;ChangeItemStyle(new list::ListViewListContentProvider);
			break;
		case 3:
			listView-&gt;ChangeItemStyle(new list::ListViewDetailContentProvider);
			break;
		case 4:
			listView-&gt;ChangeItemStyle(new list::ListViewTileContentProvider);
			break;
		case 5:
			listView-&gt;ChangeItemStyle(new list::ListViewInformationContentProvider);
			break;
		}
	}

	void buttonRefresh_Clicked(GuiGraphicsComposition* sender, GuiEventArgs& arguments)
	{
		WString directory=textDirectory-&gt;GetText();
		if(directory.Length()&gt;0 && directory[directory.Length()-1]==L'\\')
		{
			directory=directory.Left(directory.Length()-1);
		}
		dataSource-&gt;SetDirectory(directory);
	}
</strong>
public:
	VirtualModeWindow()
		:GuiWindow(GetCurrentTheme()-&gt;CreateWindowStyle())
	{
		this-&gt;SetText(L"Controls.ListView.VirtualMode");

		GuiTableComposition* table=new GuiTableComposition;
		table-&gt;SetCellPadding(4);
		table-&gt;SetAlignmentToParent(Margin(0, 0, 0, 0));
		table-&gt;SetRowsAndColumns(2, 3);
		table-&gt;SetRowOption(0, GuiCellOption::MinSizeOption());
		table-&gt;SetRowOption(1, GuiCellOption::PercentageOption(1.0));
		table-&gt;SetColumnOption(0, GuiCellOption::MinSizeOption());
		table-&gt;SetColumnOption(1, GuiCellOption::PercentageOption(1.0));
		table-&gt;SetColumnOption(2, GuiCellOption::MinSizeOption());
		{
			GuiCellComposition* cell=new GuiCellComposition;
			table-&gt;AddChild(cell);
			cell-&gt;SetSite(0, 0, 1, 1);

			GuiTextList* comboSource=g::NewTextList();
			comboSource-&gt;GetItems().Add(L"Big Icon");
			comboSource-&gt;GetItems().Add(L"Small Icon");
			comboSource-&gt;GetItems().Add(L"List");
			comboSource-&gt;GetItems().Add(L"Detail");
			comboSource-&gt;GetItems().Add(L"Tile");
			comboSource-&gt;GetItems().Add(L"Information");
			comboSource-&gt;SetHorizontalAlwaysVisible(false);

			comboView=g::NewComboBox(comboSource);
			comboView-&gt;SetSelectedIndex(0);
			comboView-&gt;GetBoundsComposition()-&gt;SetAlignmentToParent(Margin(0, 0, -1, 0));
			comboView-&gt;GetBoundsComposition()-&gt;SetPreferredMinSize(Size(160, 0));
			<strong>comboView-&gt;SelectedIndexChanged.AttachMethod(this, &VirtualModeWindow::comboView_SelectedIndexChanged);</strong>
			cell-&gt;AddChild(comboView-&gt;GetBoundsComposition());
		}
		{
			GuiCellComposition* cell=new GuiCellComposition;
			table-&gt;AddChild(cell);
			cell-&gt;SetSite(0, 1, 1, 1);

			textDirectory=g::NewTextBox();
			textDirectory-&gt;GetBoundsComposition()-&gt;SetAlignmentToParent(Margin(0, 0, 0, 0));
			cell-&gt;AddChild(textDirectory-&gt;GetBoundsComposition());
		}
		{
			GuiCellComposition* cell=new GuiCellComposition;
			table-&gt;AddChild(cell);
			cell-&gt;SetSite(0, 2, 1, 1);

			buttonRefresh=g::NewButton();
			buttonRefresh-&gt;SetText(L"&lt;- Load this directory");
			buttonRefresh-&gt;GetBoundsComposition()-&gt;SetAlignmentToParent(Margin(0, 0, 0, 0));
			<strong>buttonRefresh-&gt;Clicked.AttachMethod(this, &VirtualModeWindow::buttonRefresh_Clicked);</strong>
			cell-&gt;AddChild(buttonRefresh-&gt;GetBoundsComposition());
		}
		{
			GuiCellComposition* cell=new GuiCellComposition;
			table-&gt;AddChild(cell);
			cell-&gt;SetSite(1, 0, 1, 3);

			dataSource=new DataSource;

			listView=new GuiVirtualListView(GetCurrentTheme()-&gt;CreateListViewStyle(), dataSource);
			listView-&gt;GetBoundsComposition()-&gt;SetAlignmentToParent(Margin(0, 0, 0, 0));
			listView-&gt;SetHorizontalAlwaysVisible(false);
			listView-&gt;SetVerticalAlwaysVisible(false);
			listView-&gt;SetMultiSelect(true);
			cell-&gt;AddChild(listView-&gt;GetBoundsComposition());
		}
		this-&gt;GetBoundsComposition()-&gt;AddChild(table);

		textDirectory-&gt;SetText(GetWindowsDirectory());
		dataSource-&gt;SetDirectory(textDirectory-&gt;GetText());

		// set the preferred minimum client size
		this-&gt;GetBoundsComposition()-&gt;SetPreferredMinSize(Size(640, 480));
		// call this to calculate the size immediately if any indirect content in the table changes
		// so that the window can calcaulte its correct size before calling the MoveToScreenCenter()
		this-&gt;ForceCalculateSizeImmediately();
		// move to the screen center
		this-&gt;MoveToScreenCenter();
	}
};

/***********************************************************************
File System Operations
***********************************************************************/

WString GetWindowsDirectory()
{
	wchar_t folderPath[MAX_PATH]={0};
	HRESULT hr=SHGetFolderPath(NULL, CSIDL_WINDOWS, NULL, 0, folderPath);
	if(FAILED(hr)) return L"";
	return folderPath;
}

void SearchDirectoriesAndFiles(const WString& path, List&lt;WString&gt;& directories, List&lt;WString&gt;& files)
{
	// Use FindFirstFile, FindNextFile and FindClose to enumerate all directories and files
	WIN32_FIND_DATA findData;
	HANDLE findHandle=INVALID_HANDLE_VALUE;

	while(true)
	{
		if(findHandle==INVALID_HANDLE_VALUE)
		{
			WString searchPath=path+L"\\*";
			findHandle=FindFirstFile(searchPath.Buffer(), &findData);
			if(findHandle==INVALID_HANDLE_VALUE)
			{
				break;
			}
		}
		else
		{
			BOOL result=FindNextFile(findHandle, &findData);
			if(result==0)
			{
				FindClose(findHandle);
				break;
			}
		}

		if(findData.dwFileAttributes & FILE_ATTRIBUTE_DIRECTORY)
		{
			if(wcscmp(findData.cFileName, L".")!=0 && wcscmp(findData.cFileName, L"..")!=0)
			{
				directories.Add(findData.cFileName);
			}
		}
		else
		{
			files.Add(findData.cFileName);
		}
	}

	Func&lt;vint(WString a, WString b)&gt; comparer=[](WString a, WString b){return _wcsicmp(a.Buffer(), b.Buffer());};
	CopyFrom(directories.Wrap(), directories.Wrap()&gt;&gt;OrderBy(comparer));
	CopyFrom(files.Wrap(), files.Wrap()&gt;&gt;OrderBy(comparer));
}

Ptr&lt;GuiImageData&gt; GetFileIcon(const WString& fullPath, UINT uFlags)
{
	// Use SHGetFileInfo to get the correct icons for the specified directory or file.
	SHFILEINFO info;
	DWORD result=SHGetFileInfo(fullPath.Buffer(), 0, &info, sizeof(SHFILEINFO), uFlags);
	Ptr&lt;GuiImageData&gt; imageData;
	if(result)
	{
		Ptr&lt;INativeImage&gt; image=windows::CreateImageFromHICON(info.hIcon);
		if(image)
		{
			imageData=new GuiImageData(image, 0);
		}
		DestroyIcon(info.hIcon);
	}
	return imageData;
}

WString GetFileDisplayName(const WString& fullPath)
{
	SHFILEINFO info;
	DWORD result=SHGetFileInfo(fullPath.Buffer(), 0, &info, sizeof(SHFILEINFO), SHGFI_DISPLAYNAME);
	return result?info.szDisplayName:L"";
}

WString GetFileTypeName(const WString& fullPath)
{
	SHFILEINFO info;
	DWORD result=SHGetFileInfo(fullPath.Buffer(), 0, &info, sizeof(SHFILEINFO), SHGFI_TYPENAME);
	return result?info.szTypeName:L"";
}

WString GetFileLastWriteTime(const WString& fullPath)
{
	// Get file attributes.
	WIN32_FILE_ATTRIBUTE_DATA info;
	BOOL result=GetFileAttributesEx(fullPath.Buffer(), GetFileExInfoStandard, &info);

	// Get the localized string for the file last write date.
	FILETIME localFileTime;
	SYSTEMTIME localSystemTime;
	FileTimeToLocalFileTime(&info.ftLastWriteTime, &localFileTime);
	FileTimeToSystemTime(&localFileTime, &localSystemTime);

	// Get the correct locale
	wchar_t localeName[LOCALE_NAME_MAX_LENGTH]={0};
	GetSystemDefaultLocaleName(localeName, sizeof(localeName)/sizeof(*localeName));

	// Get the localized date string
	wchar_t dateString[100]={0};
	GetDateFormatEx(localeName, DATE_SHORTDATE, &localSystemTime, NULL, dateString, sizeof(dateString)/sizeof(*dateString), NULL);

	// Get the localized time string
	wchar_t timeString[100]={0};
	GetTimeFormatEx(localeName, TIME_FORCE24HOURFORMAT | TIME_NOSECONDS, &localSystemTime, NULL, timeString, sizeof(timeString)/sizeof(*timeString));

	return dateString+WString(L" ")+timeString;
}

WString GetFileSize(const WString& fullPath)
{
	// Get file attributes.
	WIN32_FILE_ATTRIBUTE_DATA info;
	BOOL result=GetFileAttributesEx(fullPath.Buffer(), GetFileExInfoStandard, &info);

	// Get the string for file size
	LARGE_INTEGER li;
	li.HighPart=info.nFileSizeHigh;
	li.LowPart=info.nFileSizeLow;

	WString unit;
	double size=0;
	if(li.QuadPart&gt;=1024*1024*1024)
	{
		unit=L" GB";
		size=(double)li.QuadPart/(1024*1024*1024);
	}
	else if(li.QuadPart&gt;=1024*1024)
	{
		unit=L" MB";
		size=(double)li.QuadPart/(1024*1024);
	}
	else if(li.QuadPart&gt;=1024)
	{
		unit=L" KB";
		size=(double)li.QuadPart/1024;
	}
	else
	{
		unit=L" Bytes";
		size=(double)li.QuadPart;
	}

	WString sizeString=ftow(size);
	const wchar_t* reading=sizeString.Buffer();
	const wchar_t* point=wcschr(sizeString.Buffer(), L'.');
	if(point)
	{
		const wchar_t* max=reading+sizeString.Length();
		point+=4;
		if(point&gt;max) point=max;
		sizeString=sizeString.Left(point-reading);
	}

	return sizeString+unit;
}

/***********************************************************************
GuiMain
***********************************************************************/

void GuiMain()
{
	GuiWindow* window=new VirtualModeWindow;
	GetApplication()-&gt;Run(window);
	delete window;
}
                        </pre>
                    </td>
                </tr>
            </table>
        </td>
    </tr>
</table>
</body>
</html>